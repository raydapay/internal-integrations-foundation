
import unittest
from unittest.mock import AsyncMock

import httpx

from src.core.clients import JiraClient


class TestJiraPermissionsValidator(unittest.IsolatedAsyncioTestCase):
    """Test suite for the proactive Jira Project permissions validator."""

    def setUp(self) -> None:
        self.client = JiraClient()
        self.client.client = AsyncMock()

    async def test_validate_project_permissions_all_granted(self) -> None:
        """Verifies true is returned when all required permissions evaluate to havePermission=True."""
        mock_response = AsyncMock()
        mock_response.json.return_value = {
            "permissions": {
                "CREATE_ISSUES": {"havePermission": True},
                "EDIT_ISSUES": {"havePermission": True},
                "ASSIGN_ISSUES": {"havePermission": True},
                "MODIFY_REPORTER": {"havePermission": True},
                "TRANSITION_ISSUES": {"havePermission": True},
                "ADD_COMMENTS": {"havePermission": True},
            }
        }
        self.client.client.get.return_value = mock_response

        is_valid, missing = await self.client.validate_project_permissions("HR")

        self.assertTrue(is_valid)
        self.assertEqual(len(missing), 0)
        self.client.client.get.assert_awaited_once()

    async def test_validate_project_permissions_partial_access(self) -> None:
        """Verifies missing permissions are correctly identified and aggregated."""
        mock_response = AsyncMock()
        # Simulate a token that can create and edit, but cannot assign or modify the reporter
        mock_response.json.return_value = {
            "permissions": {
                "CREATE_ISSUES": {"havePermission": True},
                "EDIT_ISSUES": {"havePermission": True},
                "ASSIGN_ISSUES": {"havePermission": False},
                "MODIFY_REPORTER": {"havePermission": False},
                "TRANSITION_ISSUES": {"havePermission": True},
                "ADD_COMMENTS": {"havePermission": True},
            }
        }
        self.client.client.get.return_value = mock_response

        is_valid, missing = await self.client.validate_project_permissions("IT")

        self.assertFalse(is_valid)
        self.assertIn("MODIFY_REPORTER", missing)
        self.assertIn("ASSIGN_ISSUES", missing)
        self.assertEqual(len(missing), 2)

    async def test_validate_project_permissions_http_error(self) -> None:
        """Verifies that network or authorization failures bubble up the HTTPStatusError."""
        mock_request = httpx.Request("GET", "https://api.atlassian.com")
        mock_response = httpx.Response(404, request=mock_request)

        self.client.client.get.side_effect = httpx.HTTPStatusError(
            "Project Not Found", request=mock_request, response=mock_response
        )

        with self.assertRaises(httpx.HTTPStatusError):
            await self.client.validate_project_permissions("INVALID")


if __name__ == "__main__":
    unittest.main()