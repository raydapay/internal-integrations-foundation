{% extends "base.html" %}

{% block title %}Global Settings{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">Global Settings</h1>
    <p class="subtitle text-muted">Manage core execution parameters and default fallback values.</p>

    <div class="box">
        <form hx-post="/admin/settings" hx-target="#toast-container" hx-swap="beforeend">

            <div class="field">
                <label class="label">Master Execution Switch</label>
                <div class="control">
                    <label class="checkbox">
                        <input type="checkbox" name="is_active" value="true" {% if config and config.is_active %}checked{% endif %}>
                        <strong>Enable background synchronization (PeopleForce ‚Üî Jira)</strong>
                    </label>
                </div>
                <p class="help text-muted">Unchecking this instantly yields the worker without killing the underlying OS process.</p>
            </div>

            <hr class="my-5">

            <div class="columns">
                <div class="column is-6">
                    <div class="field">
                        <label class="label">Polling Interval (Seconds)</label>
                        <div class="control">
                            <input class="input" type="number" name="polling_interval_seconds" value="{{ config.polling_interval_seconds if config else 300 }}" min="10" required>
                        </div>
                        <p class="help text-muted">How frequently the engine queries the PeopleForce API for new or updated tasks. Recommended: 60 - 300.</p>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">Default Jira Project</label>
                        <div class="control">
                            <select name="default_jira_project" class="tom-select-init" placeholder="-- None --">
                                <option value="">-- None --</option>
                                {% for p in jira_projects %}
                                <option value="{{ p.key }}" {% if config and config.default_jira_project == p.key %}selected{% endif %}>{{ p.name }} ({{ p.key }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <p class="help text-muted mt-2">The ultimate fallback destination if a task passes the firewall but matches no specific routing rules.</p>
                    </div>
                </div>
            </div>
            <hr class="my-5">
            <h3 class="title is-5">Jira Integration Constants</h3>

            <div class="columns is-multiline">

                <div class="column is-6">
                    <div class="field">
                        <label class="label">Fallback Account ID</label>
                        <div class="control">get_task_type_options
                            <input class="input" type="text" name="jira_fallback_account_id" value="{{ config.jira_fallback_account_id if config else '' }}">
                        </div>
                        <p class="help text-muted">The Jira Account ID to assign tasks to if identity mapping fails.</p>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">Jira Tracking Label</label>
                        <div class="control">
                            <input class="input" type="text" name="jira_tracking_label" value="{{ config.jira_tracking_label if config else 'PeopleForce' }}" required>
                        </div>
                        <p class="help text-muted">The label appended to all synced issues for JQL tracking and Return Vector sweeping.</p>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">Entity Property Key</label>
                        <div class="control">
                            <input class="input" type="text" name="jira_entity_property_key" value="{{ config.jira_entity_property_key if config else 'pf_sync_metadata' }}" required>
                        </div>
                        <p class="help text-muted">The invisible entity property key storing immutable state metadata.</p>
                    </div>
                </div>
            </div>
            <hr class="my-5">
            <hr class="my-5">
            <h3 class="title is-5">Health & Alerting Thresholds</h3>
            <p class="subtitle is-6 text-muted mb-4">Set to 0 to disable a specific check.</p>

            <div class="columns is-multiline">

                <div class="column is-6">
                    <div class="field">
                        <label class="label">
                            Health Check Interval (Seconds)
                            <span class="has-text-grey-light has-tooltip-right has-tooltip-multiline ml-1" data-tooltip="How often the background worker evaluates system memory, disk space, and API connectivity." style="border-bottom: none; cursor: help;">&#9432;</span>
                        </label>
                        <div class="control">
                            <input class="input" type="number" name="health_check_interval_seconds" value="{{ config.health_check_interval_seconds if config else 900 }}" min="60" required>
                        </div>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">
                            ARQ Queue Depth Limit
                            <span class="has-text-grey-light has-tooltip-right has-tooltip-multiline ml-1" data-tooltip="Triggers a Slack/Telegram alert if the asynchronous job queue backlogs beyond this threshold." style="border-bottom: none; cursor: help;">&#9432;</span>
                        </label>
                        <div class="control">
                            <input class="input" type="number" name="alert_queue_depth_threshold" value="{{ config.alert_queue_depth_threshold if config else 500 }}" min="0" required>
                        </div>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">
                            Memory Threshold (%)
                            <span class="has-text-grey-light has-tooltip-right has-tooltip-multiline ml-1" data-tooltip="Triggers an alert if host RAM usage exceeds this percentage." style="border-bottom: none; cursor: help;">&#9432;</span>
                        </label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" name="alert_mem_threshold_pct" value="{{ config.alert_mem_threshold_pct if config else 90.0 }}" min="0" max="100" required>
                        </div>
                    </div>
                </div>

                <div class="column is-6">
                    <div class="field">
                        <label class="label">
                            Disk Threshold (%)
                            <span class="has-text-grey-light has-tooltip-right has-tooltip-multiline ml-1" data-tooltip="Triggers an alert if host root partition space exceeds this percentage." style="border-bottom: none; cursor: help;">&#9432;</span>
                        </label>
                        <div class="control">
                            <input class="input" type="number" step="0.1" name="alert_disk_threshold_pct" value="{{ config.alert_disk_threshold_pct if config else 90.0 }}" min="0" max="100" required>
                        </div>
                    </div>
                </div>

            </div>

            <hr class="my-5">
            <h3 class="title is-5">Cache Management</h3>
            <p class="subtitle is-6 text-muted mb-4">Control the Stale-While-Revalidate (SWR) Jira metadata cache.</p>

            <div class="columns is-vcentered">
                <div class="column is-narrow">
                    <button type="button" class="button is-warning is-outlined"
                            hx-post="/admin/cache/refresh"
                            hx-target="#toast-container"
                            hx-swap="beforeend">
                        <span class="icon is-small">üîÑ</span>
                        <span>Refresh Jira Cache (Background)</span>
                    </button>
                </div>
                <div class="column is-narrow">
                    <button type="button" class="button is-danger is-outlined"
                            hx-post="/admin/cache/purge"
                            hx-target="#toast-container"
                            hx-swap="beforeend"
                            hx-confirm="Force a cold start? The next UI load will block until Jira responds.">
                        <span class="icon is-small">üóëÔ∏è</span>
                        <span>Purge Metadata Cache</span>
                    </button>
                </div>
                <div class="column">
                    <p class="is-size-7 has-text-grey">
                        Purging deletes all <code>jira:createmeta</code>, <code>jira:projects</code>, and <code>jira:issuetypes</code> keys from Redis.
                    </p>
                </div>
            </div>

            <div class="field mt-5">
                <div class="control">
                    <button type="submit" class="button is-primary">Save Configuration</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}