{% extends "base.html" %}

{% block title %}Mapping Rules{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">Routing Rules Engine</h1>
    <p class="subtitle text-muted">Configure priority-based conditional logic for Jira dispatch.</p>

    {% if user.role in ['system_admin', 'pf_jira_admin'] %}
    <div class="box mb-5">
        <h3 class="title is-5 mb-2">System Operations</h3>

        <div class="columns is-vcentered">
            <div class="column">
                <p class="subtitle is-6 text-muted mb-2">Manually enqueue a delta-sync job to reconcile PeopleForce tasks with Jira.</p>
                <button class="button is-primary is-small is-outlined has-tooltip-bottom"
                        data-tooltip="Bypasses the polling interval to run an immediate delta-sync."
                        hx-post="/admin/sync/pf-jira"
                        hx-target="#toast-container"
                        hx-swap="beforeend">
                    Trigger Full Delta Sync
                </button>
            </div>

            <div class="column">
                <p class="subtitle is-6 text-muted mb-2">Verify that all targeted Jira projects exist and are accessible.</p>
                <button class="button is-primary is-small is-outlined has-tooltip-bottom"
                        data-tooltip="Dispatches an async job to verify project keys and identity overrides against the Atlassian API."
                        hx-post="/admin/rules/validate/start"
                        hx-target="#validation-container"
                        hx-swap="innerHTML">
                    Validate Routing Targets
                </button>
            </div>
        </div>

        <div id="validation-container" class="mt-3"></div>
    </div>

    <button class="button is-primary"
        hx-get="/admin/rules/routing/new"
        hx-target="body"
        hx-swap="beforeend">
    <span>Add Routing Rule</span>
    </button>

    <button class="button is-info is-soft ml-2" onclick="document.getElementById('schema-helper-modal').classList.add('is-active')">
        <span class="icon is-small">ℹ️</span>
        <span>View PF Variables Reference</span>
    </button>
    <div class="box mt-5" style="overflow-x: auto;">
    {% endif %}

    <div class="box mt-5" style="overflow-x: auto;">
        <h3 class="title is-5">Evaluation Matrix</h3>
        <table class="table is-fullwidth is-striped is-hoverable is-narrow">
            <thead>
                <tr>
                    <th class="has-text-grey-light" style="width: 50px;">ID</th>
                    <th class="has-text-grey-light">Status</th>
                    <th class="has-text-grey-light">Priority</th>
                    <th class="has-text-grey-light">Action</th>
                    <th class="has-text-grey-light">Condition: Assignee</th>
                    <th class="has-text-grey-light">Condition: Title</th>
                    <th class="has-text-grey-light">Target Project</th>
                    <th class="has-text-grey-light">Dynamic Field Mappings</th>
                    <th class="has-text-grey-light has-text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="rules-tbody">
                {% include "partials/_routing_rules_tbody.html" %}
            </tbody>
        </table>
    </div>

    <div id="modal-container"></div>
</div>
        </table>
    </div>

    <div id="modal-container"></div>

    {% include "partials/_pf_schema_modal.html" %}

</div>
{% endblock %}