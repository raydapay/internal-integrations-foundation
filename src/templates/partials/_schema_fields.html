{% if required_fields %}
<div class="mb-5">
    <h4 class="title is-6 has-text-grey-dark border-bottom pb-2">Required Jira Fields</h4>
    <div class="columns is-multiline">
        {% for field_id, meta in required_fields %}
        <div class="column is-4">
            <div class="field">
                <label class="label is-small">
                    {{ meta.name }} <span class="has-text-danger" title="Required">*</span>
                </label>
                <div class="control">
                    {% if meta.allowedValues %}
                        <div class="select is-fullwidth is-small">
                            <select name="mapping_{{ field_id }}" required>
                                <option value="" disabled {% if not existing_mappings or not existing_mappings.get(field_id) %}selected{% endif %}>-- Select --</option>
                                {% for opt in meta.allowedValues %}
                                    {% set opt_val = (opt.id | default(opt.value)) | string %}
                                    <option value="{{ opt_val }}" {% if existing_mappings and existing_mappings.get(field_id) == opt_val %}selected{% endif %}>
                                        {{ opt.name | default(opt.value) }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    {% else %}
                        <input class="input is-small" type="text"
                            name="mapping_{{ field_id }}"
                            value="{{ existing_mappings.get(field_id, '') if existing_mappings else '' }}"
                            {% if meta.schema.type == 'array' %}
                            placeholder="val1, val2 or $.path or {{ template }}"
                            {% else %}
                            placeholder="Static, $.path, or {{ template }}"
                            {% endif %}
                            {% if meta.required %}required{% endif %}>
                    {% endif %}
                </div>
                <p class="help is-marginless" style="opacity: 0.7;">ID: <code>{{ field_id }}</code></p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if optional_fields %}
<details class="message">
    <summary class="message-header is-clickable" style="cursor: pointer;">
        <p>Configure Optional Fields ({{ optional_fields|length }})</p>
        <span class="icon is-small"><i class="fas fa-sliders-h"></i></span>
    </summary>

    <div class="message-body p-4">
        <div class="columns is-multiline">
            {% for field_id, meta in optional_fields %}
            <div class="column is-3">
                <div class="field">
                    <label class="label is-small">
                        {{ meta.name }}
                        <span class="has-text-grey font-weight-normal is-size-7">({{ meta.schema.type }})</span>
                    </label>
                    <div class="control">
                        {% if meta.allowedValues %}
                            <div class="select is-fullwidth is-small">
                                <select name="mapping_{{ field_id }}">
                                    <option value="" {% if not existing_mappings or not existing_mappings.get(field_id) %}selected{% endif %}>-- Not Set --</option>
                                    {% for opt in meta.allowedValues %}
                                        {% set opt_val = (opt.id | default(opt.value)) | string %}
                                        <option value="{{ opt_val }}" {% if existing_mappings and existing_mappings.get(field_id) == opt_val %}selected{% endif %}>
                                            {{ opt.name | default(opt.value) }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% else %}
                            <input class="input is-small" type="text"
                                name="mapping_{{ field_id }}"
                                value="{{ existing_mappings.get(field_id, '') if existing_mappings else '' }}"
                                {% if meta.schema.type == 'array' %}
                                placeholder="val1, val2 or $.path"
                                {% else %}
                                placeholder="Static value or $.path"
                                {% endif %}
                                {% if meta.required %}required{% endif %}>
                        {% endif %}
                    </div>
                    <p class="help is-marginless" style="opacity: 0.7;">ID: <code>{{ field_id }}</code></p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</details>
{% endif %}