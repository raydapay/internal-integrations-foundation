{% set rule_list = routing_rules if routing_rules is defined else rules %}

{% for rule in rule_list %}
<tr>
    <td>
        {% if rule.is_active %}
        <span class="is-success ">✅</span>
            <!-- <span class="tag is-success">Active</span> -->
        {% else %}
            <span class="is-danger">❌</span>
            <!-- <span class="tag is-danger">Disabled</span> -->
        {% endif %}
    </td>
    <td class="is-vcentered has-text-weight-bold">{{ rule.priority }}</td>

    <td class="is-vcentered">
        {% if rule.action.value == 'SYNC' or rule.action == 'SYNC' %}
            <button class="button is-small is-success is-outlined">SYNC</button>
        {% else %}
            <button class="button is-small is-success is-outlined">DROP</button>
        {% endif %}
    </td>

    <td class="is-vcentered">
        {% if rule.condition_assignee_pattern %}
            <button class="button is-small is-info is-outlined">{{ rule.condition_assignee_pattern }}</button>
            <!-- <span class="tag is-info ">{{ rule.condition_assignee_pattern }}</span> -->
        {% else %}
            <span class="has-text-grey">ANY</span>
        {% endif %}
    </td>

    <td class="is-vcentered">
        {% if rule.condition_title_keyword %}
            <span class="tag is-link ">{{ rule.condition_title_keyword }}</span>
        {% else %}
            <span class="has-text-grey">ANY</span>
        {% endif %}
    </td>

    <td class="is-vcentered has-text-weight-semibold">
        {{ rule.target_jira_project }}
    </td>

    <td class="is-vcentered">
    <div class="tags are-small mb-0">
        {% for mapping in rule.field_mappings %}
            {% if mapping.jira_field_id == 'issuetype' %}

                <span class="tag is-info is-themed" title="Issue Type">
                    {{ issuetype_map.get(mapping.source_value, mapping.source_value) if issuetype_map else mapping.source_value }}
                </span>
            {% elif mapping.source_type.value | string | upper == 'PF_PAYLOAD' or mapping.source_type | string | upper == 'PF_PAYLOAD' %}
                <span class="tag is-warning" title="Dynamic Extraction">
                    {{ mapping.jira_field_id }}: {{ mapping.source_value }}
                </span>
            {% else %}
                <span class="tag" title="Static Override">
                    {{ mapping.jira_field_id }}: {{ mapping.source_value }}
                </span>
            {% endif %}
        {% else %}
            <span class="has-text-grey is-italic is-size-7">No mappings configured</span>
        {% endfor %}
    </div>
</td>

    <td class="is-vcentered has-text-right">
        <div class="buttons is-right">
            <button class="button is-small is-info is-outlined"
                    hx-get="/admin/rules/routing/{{ rule.id }}/edit"
                    hx-target="body"
                    hx-swap="beforeend">
                &#128393;
            </button>

            <button class="button is-small is-danger is-outlined"
                    hx-delete="/admin/rules/routing/{{ rule.id }}"
                    hx-confirm="Are you sure you want to delete this rule?"
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                Delete
            </button>
        </div>
    </td>
</tr>
{% else %}
<tr>
    <td colspan="7" class="has-text-centered has-text-grey py-5">
        No routing rules configured.
    </td>
</tr>
{% endfor %}