{% set rule_list = routing_rules if routing_rules is defined else rules %}

{% set known_fields = {
    'assignee': 'Assignee',
    'reporter': 'Reporter',
    'duedate': 'Due Date',
    'customfield_10015': 'Start Date',
    'labels': 'Labels',
    'priority': 'Priority',
    'components': 'Components'
} %}

{% for rule in rule_list %}
<tr>
    <td class="is-vcentered has-text-grey has-text-weight-bold">#{{ rule.id }}</td>

    <td class="is-vcentered">
        {% if rule.is_active %}
            <span class="is-success" title="Active">✅</span>
        {% else %}
            <span class="is-danger" title="Disabled">❌</span>
        {% endif %}
    </td>

    <td class="is-vcentered has-text-weight-bold">{{ rule.priority }}</td>

    <td class="is-vcentered">
        {% if rule.action.value | string | upper == 'SYNC' %}
            <span class="tag is-success is-light">SYNC</span>
        {% else %}
            <span class="tag is-danger is-light">DROP</span>
        {% endif %}
    </td>

    <td class="is-vcentered">
        {% if rule.condition_assignee_pattern %}
            <span class="tag is-info is-light">{{ rule.condition_assignee_pattern }}</span>
        {% else %}
            <span class="has-text-grey is-size-7">ANY</span>
        {% endif %}
    </td>

    <td class="is-vcentered">
        {% if rule.condition_title_keyword %}
            <span class="tag is-link is-light">{{ rule.condition_title_keyword }}</span>
        {% else %}
            <span class="has-text-grey is-size-7">ANY</span>
        {% endif %}
    </td>

    <td class="is-vcentered has-text-weight-semibold">
        {{ rule.target_jira_project }}
    </td>

    <td class="is-vcentered">
        <div class="tags are-small mb-0">
            {% for mapping in rule.field_mappings %}

                {% if mapping.jira_field_id in ['summary', 'description'] %}
                    {# Silently skipped #}

                {% elif mapping.jira_field_id == 'issuetype' %}
                    <span class="tag is-info is-light" title="Issue Type">
                        {{ issuetype_map.get(mapping.source_value, mapping.source_value) if issuetype_map else mapping.source_value }}
                    </span>

                {% else %}
                    {% set field_name = known_fields.get(mapping.jira_field_id, mapping.jira_field_id) %}

                    {% if mapping.source_type.value | string | upper == 'PF_PAYLOAD' or mapping.source_type | string | upper == 'PF_PAYLOAD' %}
                        <span class="tag is-warning is-light" title="Extraction: {{ mapping.source_value }}" style="cursor: help;">
                            {{ field_name | capitalize }}
                        </span>
                    {% else %}
                        <span class="tag is-primary is-light" title="Template: {{ mapping.source_value }}" style="cursor: help;">
                            {{ field_name | capitalize }}
                        </span>
                    {% endif %}
                {% endif %}

            {% else %}
                <span class="has-text-grey is-italic is-size-7">No mappings configured</span>
            {% endfor %}
        </div>
    </td>

    <td class="is-vcentered has-text-right">
        <div class="buttons is-right are-small is-flex-nowrap">
            <button class="button is-info is-outlined"
                    hx-get="/admin/rules/routing/{{ rule.id }}/edit"
                    hx-target="body"
                    hx-swap="beforeend">
                &#128393; Edit
            </button>

            <button class="button is-danger is-outlined"
                    hx-delete="/admin/rules/routing/{{ rule.id }}"
                    hx-confirm="Are you sure you want to delete Rule #{{ rule.id }}?"
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                Delete
            </button>
        </div>
    </td>
</tr>
{% else %}
<tr>
    <td colspan="9" class="has-text-centered has-text-grey py-5">
        No routing rules configured.
    </td>
</tr>
{% endfor %}